name: Continuous Integration
on: [push, pull_request]
jobs:
  tests:
    name: Run Test
    runs-on: ubuntu-latest
    steps:
      - name: Set up Go
        uses: actions/setup-go@v1
        with:
          go-version: 1.13
      - name: Check out code into the Go module directory
        uses: actions/checkout@v1
      - name: Get dependencies
        run: |
          go get -u golang.org/x/lint/golint
          go get -v -t -d ./...
      - name: Run go fmt
        run: diff -u <(echo -n) <(gofmt -d -s .)
      - name: Run go vet
        run: go vet ./...
      - name: Run go lint
        run: |
          # Temporary fix for:
          # https://github.com/actions/setup-go/issues/14
          export PATH=$PATH:$(go env GOPATH)/bin
          golint -set_exit_status ./...
      - name: Run tests
        run: go test -v ./...
      - name: Run bats tests
        run: |
          ./script/build.bash linux amd64 `./script/git-version.bash`
          mv dist/hcloud* cmd/hcloud/hcloud
          PATH="./cmd/hcloud:$PATH" bats/bin/bats test
  build-macos:
    name: Developer Build (MacOS)
    runs-on: ubuntu-latest
    steps:
      - name: Set up Go
        uses: actions/setup-go@v1
        with:
          go-version: 1.13
      - name: Check out code into the Go module directory
        uses: actions/checkout@v1
      - name: Get dependencies
        run: |
          go get -u golang.org/x/lint/golint
          go get -v -t -d ./...
      - name: Build
        run: |
          ./script/package.bash darwin amd64 `./script/git-version.bash`


