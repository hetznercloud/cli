sudo: false
language: go
stages:
  - tests
  - name: release
    if: tag IS present
go:
  - "1.11"
env:
  - GO111MODULE=on
before_script:
  - git clone --depth 1 https://github.com/sstephenson/bats.git
script:
  - diff -u <(echo -n) <(gofmt -d -s $(find . -type f -name '*.go'))
  - go test ./cli/...
  - ./script/build.bash linux amd64 `./script/git-version.bash`; mv dist/hcloud* cmd/hcloud/hcloud
  - PATH="./cmd/hcloud:$PATH" bats/bin/bats test
  - while read os arch _; do echo $os/$arch; GOOS=$os GOARCH=$arch go build ./cmd/hcloud; done < script/variants.txt


jobs:
  include:
    - stage: release
      if: tag IS present
      go: "1.11"
      before_deploy:
        - ./script/package_travis.bash ${TRAVIS_TAG}
      deploy:
        provider: releases
        api_key:
          secure: "zS2o1qIBIaw0TnPetURrokmf2ndl64L3KBI4Vj/RQFZtYNQCpoQkO6uj0ocN+zUaIj2rVhzlQil0mjGagf+xSSIoQPyhR5OSJ40S48skKEtTWl5ZNzY3IqSE67mbUnUy3NZwFRw/vwDxpdbIkr/m+mm3QGFY3rb2KZHkNDnovpFJlQ2XGLeS5mJpeZsri+V9lOBGrDR6q3HAEI+Tv1otujXmZGtmUhBawijBARb+t0o/K9Un+OXt8rYFivX1AsCnY5B8u6P3kvygro2TLlfB1Vx71DummRNAz0rsDeP81DyCHuZNFio33d1PtwMAHkUHW0sXjM7UKqsBhiSa7IOIehwiougfz/Olv25NFCzx/KRAor3H4X3bbGaCiX92O95CzfmezUu8d6d6Y1aOTzOO+HoSJeUMyrevWKd6JYjvEB16d1FHoAPFVppmiQKLRfxrT91OKTMOwbc0agA7Drp5Z3kcQfr6Y7GoLI9Qn7Ohtcrd1g1D8JkgkzzA1T8yPphudNcswOkU9a+wNKqa6+WVm7K+JiWszvnfox2+R7vZYaDuqyMtPAVHoTApoWliaZgyb5K7lXrzuDHipcr1jkTLOdYYVipon5MDTykvK6lx/qtPQL528uc2yE8tv5x088djGZsDxS7oF4cngrQQUNCo5/UuWI6DZLrJDYhgEiNN3Fo="
        file_glob: true
        file: dist/*
        skip_cleanup: true
        draft: true
        on:
          tags: true